<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>化学必会物质匹配游戏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',      // 主色调-蓝色（符号/化学式卡片）
                        secondary: '#f97316',    // 辅助色-橙色（名称卡片）
                        warning: '#ef4444',      // 警告色-红色（倒计时警告）
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-selected {
                transform: scale(1.08);
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            .card-matched {
                animation: pulse 0.5s;
            }
            .timer-warning {
                animation: warning 1s infinite alternate;
            }
            .container {
                max-width: 540px;  /* 手机模式最大宽度 */
            }
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.05); }
            }
            @keyframes warning {
                from { color: #ef4444; }
                to { color: #dc2626; }
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen font-sans">
    <div class="container mx-auto px-3 sm:px-4 py-5">
        <header class="text-center mb-5">
            <h1 class="text-[clamp(1.3rem,4vw,2rem)] font-bold text-gray-800 mb-2 tracking-tight">
                化学必会物质<span class="text-primary">匹配游戏</span>
            </h1>
            <p class="text-gray-600 text-sm sm:text-base mb-4 max-w-2xl mx-auto">
                根据物质名称输入对应的化学式，提升化学学习效率
            </p>
            
            <!-- 游戏设置区域 -->
            <div class="mb-5 bg-white rounded-lg shadow-md p-3 max-w-3xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-4">
                <div>
                    <label for="elementCount" class="block text-gray-700 text-sm font-medium mb-1.5">选择物质数量:</label>
                    <div class="flex items-center">
                        <select id="elementCount" class="flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
                            <option value="5">5种物质</option>
                            <option value="10">10种物质</option>
                            <option value="15">15种物质</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label for="timingMode" class="block text-gray-700 text-sm font-medium mb-1.5">选择计时方式:</label>
                    <div class="flex items-center">
                        <select id="timingMode" class="flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
                            <option value="timed">计时模式</option>
                            <option value="countdown">倒计时模式</option>
                            <option value="untimed">无计时模式</option>
                        </select>
                    </div>
                </div>
                
                <div id="countdownSettings">
                    <label for="countdownDuration" class="block text-gray-700 text-sm font-medium mb-1.5">倒计时时长(秒):</label>
                    <div class="flex items-center">
                        <input type="number" id="countdownDuration" min="30" max="300" value="120" 
                               class="flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
                    </div>
                </div>
            </div>
            
            <!-- 数据展示区域 -->
            <div class="flex flex-wrap justify-center gap-2 sm:gap-3 mb-5">
                <div id="timerContainer" class="bg-white rounded-lg shadow-md px-3 py-2 flex items-center text-sm">
                    <i class="fa fa-clock-o text-primary mr-1.5"></i>
                    <span class="text-gray-700" id="timerLabel">时间: </span>
                    <span id="timer" class="font-semibold ml-1.5">00:00</span>
                </div>
                
                <div class="bg-white rounded-lg shadow-md px-3 py-2 flex items-center text-sm">
                    <i class="fa fa-hand-pointer-o text-primary mr-1.5"></i>
                    <span class="text-gray-700">尝试次数: </span>
                    <span id="attempts" class="font-semibold ml-1.5">0</span>
                </div>
                
                <div class="bg-white rounded-lg shadow-md px-3 py-2 flex items-center text-sm">
                    <i class="fa fa-check-circle text-primary mr-1.5"></i>
                    <span class="text-gray-700">匹配: </span>
                    <span id="matches" class="font-semibold ml-1.5">0/0</span>
                </div>
            </div>
            
            <div class="flex flex-wrap justify-center gap-3">
                <button id="startBtn" class="bg-primary hover:bg-primary/90 text-white text-sm font-bold py-2 px-5 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none">
                    开始游戏
                </button>
                <button id="historyBtn" class="bg-gray-700 hover:bg-gray-800 text-white text-sm font-bold py-2 px-5 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none">
                    查看历史
                </button>
            </div>
        </header>
        
        <!-- 游戏区域 -->
        <div class="grid grid-cols-1 gap-4 mb-5">
            <div id="nameContainer" class="opacity-50 pointer-events-none transition-opacity duration-500">
                <h2 class="text-sm sm:text-base font-semibold text-secondary mb-3 text-center">物质名称与化学式输入</h2>
                <div class="grid grid-cols-1 gap-3">
                    <!-- 中文名称与输入框将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
        
        <!-- 游戏结束弹窗 -->
        <div id="gameOverModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl p-5 sm:p-6 max-w-md w-full mx-3 transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
                <div class="text-center mb-3">
                    <div id="gameOverIcon" class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-green-100 mb-3">
                        <i class="fa fa-trophy text-2xl text-yellow-500"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800 mb-1.5" id="gameOverTitle">恭喜你！</h2>
                    <p class="text-gray-600 text-sm" id="completionText">你已完成所有物质的匹配</p>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div id="finalTimeContainer" class="flex justify-between mb-2 pb-2 border-b border-gray-100">
                        <span class="text-gray-600 text-sm">用时/剩余时间:</span>
                        <span id="finalTime" class="font-semibold text-gray-800 text-sm">00:00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 text-sm">尝试次数:</span>
                        <span id="finalAttempts" class="font-semibold text-gray-800 text-sm">0</span>
                    </div>
                    <div class="flex justify-between mt-2 pt-2 border-t border-gray-100">
                        <span class="text-gray-600 text-sm">物质数量:</span>
                        <span id="finalElementCount" class="font-semibold text-gray-800 text-sm">0</span>
                    </div>
                </div>
                
                <div class="flex flex-col gap-2">
                    <button id="closeResultBtn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 focus:outline-none">
                        返回主页
                    </button>
                    <button id="playAgainBtn" class="w-full bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none">
                        再玩一次
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 再玩一次确认弹窗 -->
        <div id="playAgainConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl p-5 max-w-md w-full mx-3 transform transition-all duration-300 scale-95 opacity-0" id="playAgainModalContent">
                <div class="text-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800 mb-2">准备开始新游戏</h2>
                    <p class="text-gray-600 text-sm">请确认你的游戏设置，然后点击开始</p>
                </div>
                
                <button id="confirmStartBtn" class="w-full bg-primary hover:bg-primary/90 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none">
                    开始游戏
                </button>
            </div>
        </div>
        
        <!-- 历史记录弹窗 -->
        <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl p-5 max-w-2xl w-full mx-3 max-h-[70vh] overflow-hidden flex flex-col" id="historyModalContent">
                <div class="text-center mb-3">
                    <h2 class="text-lg font-bold text-gray-800 mb-1.5">游戏历史记录</h2>
                    <p class="text-gray-600 text-sm">所有游戏结果记录（成功/失败）</p>
                </div>
                
                <div class="flex-1 overflow-y-auto mb-4 text-sm">
                    <div id="historyList" class="space-y-3">
                        <div class="text-center text-gray-500 py-6 text-sm" id="emptyHistory">
                            暂无历史记录
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button id="clearHistoryBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm font-bold py-2 px-3 rounded-lg shadow-md transition-all duration-300 focus:outline-none">
                        清空记录
                    </button>
                    <button id="closeHistoryBtn" class="flex-1 bg-primary hover:bg-primary/90 text-white text-sm font-bold py-2 px-3 rounded-lg shadow-md transition-all duration-300 focus:outline-none">
                        关闭
                    </button>
                    <button id="exportHistoryBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-2 px-3 rounded-lg shadow-md transition-all duration-300 focus:outline-none">
                        <i class="fa fa-download mr-1"></i> 导出记录
                    </button>
                </div>
            </div>
        </div>
        
        <footer class="text-center text-gray-500 text-xs py-3">
            <p>化学必会物质匹配游戏 | 基于九年级暑假学习资料</p>
        </footer>
    </div>
    <script>
        const elements = [
            { symbol: 'H₂', name: '氢气' },
            { symbol: 'O₂', name: '氧气' },
            { symbol: 'O₃', name: '臭氧' },
            { symbol: 'N₂', name: '氮气' },
            { symbol: 'Cl₂', name: '氯气' },
            { symbol: 'CO', name: '一氧化碳' },
            { symbol: 'CO₂', name: '二氧化碳' },
            { symbol: 'SO₂', name: '二氧化硫' },
            { symbol: 'H₂O', name: '水' },
            { symbol: 'H₂O₂', name: '过氧化氢(双氧水)' },
            { symbol: 'MnO₂', name: '二氧化锰' },
            { symbol: 'NaOH', name: '氢氧化钠' },
            { symbol: 'HCl', name: '盐酸' },
            { symbol: 'H₂SO₄', name: '硫酸' },
            { symbol: 'KMnO₄', name: '高锰酸钾' },
            { symbol: 'K₂MnO₄', name: '锰酸钾' }
        ];
        
        const gameState = {
            isPlaying: false,
            matchedPairs: 0,
            totalPairs: 0,
            attempts: 0,
            timer: null,
            seconds: 0,
            countdownSeconds: 0,
            originalCountdown: 0,
            timingMode: 'timed',
            currentElements: [],
            gameStartTime: null,
            isReset: false
        };
        
        const nameContainer = document.getElementById('nameContainer').querySelector('div');
        const startBtn = document.getElementById('startBtn');
        const historyBtn = document.getElementById('historyBtn');
        const timerDisplay = document.getElementById('timer');
        const timerLabel = document.getElementById('timerLabel');
        const timerContainer = document.getElementById('timerContainer');
        const attemptsDisplay = document.getElementById('attempts');
        const matchesDisplay = document.getElementById('matches');
        const gameOverModal = document.getElementById('gameOverModal');
        const modalContent = document.getElementById('modalContent');
        const finalTime = document.getElementById('finalTime');
        const finalTimeContainer = document.getElementById('finalTimeContainer');
        const finalAttempts = document.getElementById('finalAttempts');
        const finalElementCount = document.getElementById('finalElementCount');
        const playAgainBtn = document.getElementById('playAgainBtn');
        const closeResultBtn = document.getElementById('closeResultBtn');
        const elementCountSelect = document.getElementById('elementCount');
        const exportHistoryBtn = document.getElementById('exportHistoryBtn');
        const timingModeSelect = document.getElementById('timingMode');
        const countdownSettings = document.getElementById('countdownSettings');
        const countdownDuration = document.getElementById('countdownDuration');
        const completionText = document.getElementById('completionText');
        const gameOverTitle = document.getElementById('gameOverTitle');
        const gameOverIcon = document.getElementById('gameOverIcon');
        const historyModal = document.getElementById('historyModal');
        const historyModalContent = document.getElementById('historyModalContent');
        const historyList = document.getElementById('historyList');
        const emptyHistory = document.getElementById('emptyHistory');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const closeHistoryBtn = document.getElementById('closeHistoryBtn');
        const playAgainConfirmModal = document.getElementById('playAgainConfirmModal');
        const playAgainModalContent = document.getElementById('playAgainModalContent');
        const confirmStartBtn = document.getElementById('confirmStartBtn');
        
        startBtn.addEventListener('click', handleStartButton);
        playAgainBtn.addEventListener('click', showPlayAgainConfirm);
        closeResultBtn.addEventListener('click', closeGameResult);
        confirmStartBtn.addEventListener('click', startNewGameFromConfirm);
        exportHistoryBtn.addEventListener('click', exportHistoryToCSV);
        historyBtn.addEventListener('click', showHistory);
        closeHistoryBtn.addEventListener('click', hideHistory);
        clearHistoryBtn.addEventListener('click', clearHistory);
        timingModeSelect.addEventListener('change', toggleCountdownSettings);
        
        function init() {
            toggleCountdownSettings();
            loadHistory();
        }
        
        function showPlayAgainConfirm() {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                gameOverModal.classList.add('hidden');
                playAgainConfirmModal.classList.remove('hidden');
                setTimeout(() => {
                    playAgainModalContent.classList.remove('scale-95', 'opacity-0');
                    playAgainModalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            }, 300);
        }
        
        function startNewGameFromConfirm() {
            playAgainModalContent.classList.remove('scale-100', 'opacity-100');
            playAgainModalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                playAgainConfirmModal.classList.add('hidden');
                startGame();
            }, 300);
        }
        
        function closeGameResult() {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                gameOverModal.classList.add('hidden');
                resetGameState();
            }, 300);
        }
        
        function handleStartButton() {
            if (gameState.isReset || !gameState.isPlaying) {
                startGame();
            } else {
                resetGameState();
            }
        }
        
        function toggleCountdownSettings() {
            if (timingModeSelect.value === 'countdown') {
                countdownSettings.classList.remove('hidden');
            } else {
                countdownSettings.classList.add('hidden');
            }
        }
        
        function startGame() {
            const selectedCount = parseInt(elementCountSelect.value);
            const selectedTimingMode = timingModeSelect.value;
            const selectedCountdown = parseInt(countdownDuration.value);
            
            if (selectedTimingMode === 'countdown' && (isNaN(selectedCountdown) || selectedCountdown < 30)) {
                alert('请设置至少30秒的倒计时');
                return;
            }
            
            resetGameState(true);
            
            gameState.totalPairs = selectedCount;
            gameState.timingMode = selectedTimingMode;
            gameState.originalCountdown = selectedCountdown;
            gameState.countdownSeconds = selectedCountdown;
            matchesDisplay.textContent = `0/${gameState.totalPairs}`;
            
            gameState.gameStartTime = new Date();
            
            if (gameState.timingMode === 'untimed') {
                timerContainer.classList.add('hidden');
                finalTimeContainer.classList.add('hidden');
            } else {
                timerContainer.classList.remove('hidden');
                finalTimeContainer.classList.remove('hidden');
                
                if (gameState.timingMode === 'countdown') {
                    timerLabel.textContent = '剩余时间: ';
                    updateTimerDisplay();
                } else {
                    timerLabel.textContent = '已用时间: ';
                }
            }
            
            gameState.currentElements = selectRandomElements(selectedCount);
            createInputForms();
            
            nameContainer.parentElement.classList.remove('opacity-50', 'pointer-events-none');
            
            setTimeout(() => {
                const items = document.querySelectorAll('.input-item');
                items.forEach((item, index) => {
                    setTimeout(() => {
                        item.classList.add('opacity-100', 'translate-y-0');
                        item.classList.remove('opacity-0', 'translate-y-4');
                    }, index * 100);
                });
            }, 100);
            
            if (gameState.timingMode === 'timed') {
                startStopwatch();
            } else if (gameState.timingMode === 'countdown') {
                startCountdown();
            }
            
            startBtn.textContent = '重置游戏';
            
            gameState.isPlaying = true;
            gameState.isReset = false;
        }
        
        function selectRandomElements(count) {
            const shuffled = [...elements].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }
        
        function createInputForms() {
            nameContainer.innerHTML = '';
            gameState.currentElements.forEach((element, index) => {
                const item = document.createElement('div');
                item.className = 'input-item bg-white rounded-lg shadow-md p-3 flex items-center gap-3 opacity-0 translate-y-4 transition-all duration-300';
                item.dataset.symbol = element.symbol;
                
                // 序号
                const number = document.createElement('div');
                number.className = 'w-6 h-6 rounded-full bg-secondary/20 text-secondary flex items-center justify-center font-bold text-sm';
                number.textContent = index + 1;
                item.appendChild(number);
                
                // 物质名称
                const name = document.createElement('div');
                name.className = 'flex-1 text-gray-800 font-medium';
                name.textContent = element.name;
                item.appendChild(name);
                
                // 输入框
                const inputContainer = document.createElement('div');
                inputContainer.className = 'flex-1 flex gap-2';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary';
                input.placeholder = '输入化学式';
                input.dataset.symbol = element.symbol;
                input.id = `input-${element.symbol}`;
                
                const button = document.createElement('button');
                button.className = 'bg-primary hover:bg-primary/90 text-white text-sm font-bold py-2 px-3 rounded-lg shadow transition-all duration-300';
                button.textContent = '提交';
                button.dataset.symbol = element.symbol;
                button.addEventListener('click', () => checkInput(element.symbol));
                
                // 回车键提交
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        checkInput(element.symbol);
                    }
                });
                
                inputContainer.appendChild(input);
                inputContainer.appendChild(button);
                item.appendChild(inputContainer);
                
                nameContainer.appendChild(item);
            });
        }
        
        function checkInput(symbol) {
            if (!gameState.isPlaying) return;
            
            const input = document.getElementById(`input-${symbol}`);
            const value = input.value.trim();
            const item = document.querySelector(`.input-item[data-symbol="${symbol}"]`);
            const button = item.querySelector('button');
            
            // 已匹配的不再处理
            if (item.classList.contains('matched')) return;
            
            // 空输入不处理
            if (!value) return;
            
            gameState.attempts++;
            attemptsDisplay.textContent = gameState.attempts;
            
            // 大小写敏感验证
            if (value === symbol) {
                // 匹配成功
                input.classList.remove('border-gray-300', 'focus:ring-primary', 'focus:border-primary');
                input.classList.add('border-green-500', 'bg-green-50');
                input.disabled = true;
                button.disabled = true;
                button.classList.remove('bg-primary', 'hover:bg-primary/90');
                button.classList.add('bg-green-500', 'cursor-not-allowed');
                item.classList.add('matched', 'card-matched', 'border-l-4', 'border-green-500');
                
                gameState.matchedPairs++;
                matchesDisplay.textContent = `${gameState.matchedPairs}/${gameState.totalPairs}`;
                
                if (gameState.matchedPairs === gameState.totalPairs) {
                    endGame(true);
                }
            } else {
                // 匹配失败
                input.classList.remove('border-gray-300', 'focus:ring-primary', 'focus:border-primary');
                input.classList.add('border-red-500', 'animate-shake');
                
                setTimeout(() => {
                    input.classList.remove('border-red-500', 'animate-shake');
                }, 800);
            }
        }
        
        function resetGameState(softReset = false) {
            nameContainer.innerHTML = '';
            
            gameState.isPlaying = false;
            gameState.matchedPairs = 0;
            gameState.attempts = 0;
            gameState.seconds = 0;
            gameState.countdownSeconds = 0;
            gameState.gameStartTime = null;
            
            attemptsDisplay.textContent = '0';
            timerDisplay.textContent = '00:00';
            timerDisplay.classList.remove('timer-warning');
            
            if (gameState.timer) {
                clearInterval(gameState.timer);
                gameState.timer = null;
            }
            
            gameOverModal.classList.add('hidden');
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            if (!softReset) {
                nameContainer.parentElement.classList.add('opacity-50', 'pointer-events-none');
                startBtn.textContent = '开始游戏';
                gameState.isReset = true;
            }
        }
        
        function startStopwatch() {
            gameState.timer = setInterval(() => {
                gameState.seconds++;
                updateTimerDisplay();
            }, 1000);
        }
        
        function startCountdown() {
            gameState.timer = setInterval(() => {
                gameState.countdownSeconds--;
                
                if (gameState.countdownSeconds <= 10) {
                    timerDisplay.classList.add('timer-warning');
                } else {
                    timerDisplay.classList.remove('timer-warning');
                }
                
                updateTimerDisplay();
                
                if (gameState.countdownSeconds <= 0) {
                    endGame(false);
                }
            }, 1000);
        }
        
        function updateTimerDisplay() {
            let seconds, minutes;
            
            if (gameState.timingMode === 'countdown') {
                seconds = gameState.countdownSeconds;
            } else {
                seconds = gameState.seconds;
            }
            
            minutes = Math.floor(seconds / 60);
            seconds = seconds % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function endGame(isSuccess) {
            if (gameState.timer) {
                clearInterval(gameState.timer);
                gameState.timer = null;
            }
            
            gameState.isPlaying = false;
            
            // 禁用所有输入框
            document.querySelectorAll('#nameContainer input').forEach(input => {
                input.disabled = true;
            });
            document.querySelectorAll('#nameContainer button').forEach(button => {
                button.disabled = true;
                button.classList.add('cursor-not-allowed');
            });
            
            if (isSuccess) {
                gameOverTitle.textContent = '恭喜你！';
                completionText.textContent = `你已完成所有${gameState.totalPairs}种物质的匹配`;
                gameOverIcon.className = 'inline-flex items-center justify-center w-12 h-12 rounded-full bg-green-100 mb-3';
                gameOverIcon.innerHTML = '<i class="fa fa-trophy text-2xl text-yellow-500"></i>';
            } else {
                gameOverTitle.textContent = '时间到！';
                completionText.textContent = `你完成了${gameState.matchedPairs}/${gameState.totalPairs}种物质的匹配`;
                gameOverIcon.className = 'inline-flex items-center justify-center w-12 h-12 rounded-full bg-red-100 mb-3';
                gameOverIcon.innerHTML = '<i class="fa fa-clock-o text-2xl text-red-500"></i>';
            }
            
            finalAttempts.textContent = gameState.attempts;
            finalElementCount.textContent = gameState.totalPairs;
            
            if (gameState.timingMode === 'countdown') {
                finalTime.textContent = `${Math.floor(gameState.countdownSeconds / 60).toString().padStart(2, '0')}:${(gameState.countdownSeconds % 60).toString().padStart(2, '0')}`;
            } else {
                finalTime.textContent = `${Math.floor(gameState.seconds / 60).toString().padStart(2, '0')}:${(gameState.seconds % 60).toString().padStart(2, '0')}`;
            }
            
            saveGameResult(isSuccess);
            
            gameOverModal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }
        
        function saveGameResult(isSuccess) {
            let history = JSON.parse(localStorage.getItem('chemistryGameHistory') || '[]');
            
            const result = {
                id: Date.now(),
                date: new Date().toLocaleString(),
                elementCount: gameState.totalPairs,
                attempts: gameState.attempts,
                isSuccess: isSuccess,
                timingMode: gameState.timingMode,
                time: gameState.timingMode === 'countdown' ? gameState.countdownSeconds : gameState.seconds,
                originalCountdown: gameState.originalCountdown
            };
            
            history.unshift(result);
            if (history.length > 20) {
                history = history.slice(0, 20);
            }
            
            localStorage.setItem('chemistryGameHistory', JSON.stringify(history));
            loadHistory();
        }
        
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('chemistryGameHistory') || '[]');
            historyList.innerHTML = '';
            
            if (history.length === 0) {
                emptyHistory.classList.remove('hidden');
                return;
            }
            
            emptyHistory.classList.add('hidden');
            
            history.forEach(record => {
                const historyItem = document.createElement('div');
                historyItem.className = `bg-gray-50 rounded-lg p-3 ${record.isSuccess ? 'border-l-4 border-green-500' : 'border-l-4 border-red-500'}`;
                
                let timeDisplay;
                if (record.timingMode === 'countdown') {
                    const usedSeconds = record.originalCountdown - record.time;
                    timeDisplay = `${Math.floor(usedSeconds / 60).toString().padStart(2, '0')}:${(usedSeconds % 60).toString().padStart(2, '0')}`;
                } else if (record.timingMode === 'timed') {
                    timeDisplay = `${Math.floor(record.time / 60).toString().padStart(2, '0')}:${(record.time % 60).toString().padStart(2, '0')}`;
                } else {
                    timeDisplay = '无计时';
                }
                
                historyItem.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="font-medium ${record.isSuccess ? 'text-green-700' : 'text-red-700'}">
                            ${record.isSuccess ? '完成挑战' : '未完成挑战'}
                        </div>
                        <div class="text-xs text-gray-500">${record.date}</div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-xs">
                        <div>物质数量: ${record.elementCount}种</div>
                        <div>尝试次数: ${record.attempts}</div>
                        <div>用时: ${timeDisplay}</div>
                    </div>
                `;
                
                historyList.appendChild(historyItem);
            });
        }
        
        function showHistory() {
            historyModal.classList.remove('hidden');
            setTimeout(() => {
                historyModalContent.classList.remove('scale-95', 'opacity-0');
                historyModalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }
        
        function hideHistory() {
            historyModalContent.classList.remove('scale-100', 'opacity-100');
            historyModalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                historyModal.classList.add('hidden');
            }, 300);
        }
        
        function clearHistory() {
            if (confirm('确定要清空所有历史记录吗？')) {
                localStorage.removeItem('chemistryGameHistory');
                loadHistory();
            }
        }
        
        function exportHistoryToCSV() {
            const history = JSON.parse(localStorage.getItem('chemistryGameHistory') || '[]');
            if (history.length === 0) {
                alert('没有历史记录可导出');
                return;
            }
            
            let csvContent = "日期,物质数量,尝试次数,结果,计时模式,用时\n";
            
            history.forEach(record => {
                let timeDisplay;
                if (record.timingMode === 'countdown') {
                    const usedSeconds = record.originalCountdown - record.time;
                    timeDisplay = `${Math.floor(usedSeconds / 60)}分${usedSeconds % 60}秒`;
                } else if (record.timingMode === 'timed') {
                    timeDisplay = `${Math.floor(record.time / 60)}分${record.time % 60}秒`;
                } else {
                    timeDisplay = '无计时';
                }
                
                const result = record.isSuccess ? '成功' : '失败';
                const mode = record.timingMode === 'timed' ? '计时模式' : 
                             record.timingMode === 'countdown' ? '倒计时模式' : '无计时模式';
                
                csvContent += `${record.date},${record.elementCount},${record.attempts},${result},${mode},${timeDisplay}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `化学物质匹配游戏历史_${new Date().toLocaleDateString()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 初始化
        init();
    </script>
</body>
</html>
