<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>化学化合价归类游戏</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义颜色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',      // 主色调-蓝色（元素分类）
                        secondary: '#f97316',    // 辅助色-橙色（化合价选项）
                        warning: '#ef4444',      // 警告色-红色（倒计时警告）
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .category-box {
                min-height: 100px;
                transition: all 0.3s ease;
            }
            .dragging {
                opacity: 0.7;
                transform: scale(1.05);
                cursor: grabbing;
                user-select: none;
                -webkit-user-select: none;
                touch-action: none; /* 新增：禁用浏览器默认触摸行为（如滚动） */
                -webkit-touch-callout: none; /* 新增：禁用触摸时的默认菜单 */
            }
            .drag-over {
                background-color: rgba(59, 130, 246, 0.15);
                border-color: rgba(59, 130, 246, 0.5);
            }
            .matched {
                animation: pulse 0.5s;
            }
            .timer-warning {
                animation: warning 1s infinite alternate;
            }
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.05); }
            }
            @keyframes warning {
                from { color: #ef4444; }
                to { color: #dc2626; }
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen font-sans">
    <!-- 限制最大宽度以适应手机设备，居中显示 -->
    <div class="container mx-auto px-3 sm:px-4 py-5 max-w-4xl">
        <!-- 游戏标题和信息 -->
        <header class="text-center mb-5">
            <h1 class="text-[clamp(1.3rem,4vw,2rem)] font-bold text-gray-800 mb-2 tracking-tight">
                化学<span class="text-primary">化合价</span>归类游戏
            </h1>
            <p class="text-gray-600 text-sm sm:text-base mb-4 max-w-2xl mx-auto">
                将下方的化合价拖拽到对应的元素分类中，完成匹配挑战
            </p>
            
            <!-- 游戏设置区域 -->
            <div class="mb-5 bg-white rounded-lg shadow-md p-3 max-w-3xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-4">
                <!-- 元素数量选择器 -->
                <div>
                    <label for="elementCount" class="block text-gray-700 text-sm font-medium mb-1.5">选择数量:</label>
                    <div class="flex items-center">
                        <select id="elementCount" class="flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
                            <option value="3">3种元素</option>
                            <option value="5">5种元素</option>
                            <option value="7" selected>7种元素</option>
                            <option value="10">10种元素</option>
                        </select>
                    </div>
                </div>
                
                <!-- 难度选择器 -->
                <div>
                    <label for="difficulty" class="block text-gray-700 text-sm font-medium mb-1.5">选择难度:</label>
                    <div class="flex items-center">
                        <select id="difficulty" class="flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
                            <option value="easy">简单（常见元素）</option>
                            <option value="medium" selected>中等（包含离子）</option>
                            <option value="hard">困难（多变价元素）</option>
                        </select>
                    </div>
                </div>
                
                <!-- 计时方式选择器 -->
                <div>
                    <label for="timingMode" class="block text-gray-700 text-sm font-medium mb-1.5">选择计时方式:</label>
                    <div class="flex items-center">
                        <select id="timingMode" class="flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
                            <option value="timed">计时模式</option>
                            <option value="countdown">倒计时模式</option>
                            <option value="untimed">无计时模式</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- 倒计时时长设置 -->
            <div id="countdownSettings" class="mb-5 bg-white rounded-lg shadow-md p-3 max-w-xs mx-auto">
                <label for="countdownDuration" class="block text-gray-700 text-sm font-medium mb-1.5">倒计时时长(秒):</label>
                <div class="flex items-center">
                    <input type="number" id="countdownDuration" min="30" max="300" value="120" 
                           class="flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
                </div>
            </div>
            
            <div class="flex flex-wrap justify-center gap-2 sm:gap-3 mb-5">
                <div id="timerContainer" class="bg-white rounded-lg shadow-md px-3 py-2 flex items-center text-sm">
                    <i class="fa fa-clock-o text-primary mr-1.5"></i>
                    <span class="text-gray-700" id="timerLabel">时间: </span>
                    <span id="timer" class="font-semibold ml-1.5">00:00</span>
                </div>
                
                <div class="bg-white rounded-lg shadow-md px-3 py-2 flex items-center text-sm">
                    <i class="fa fa-hand-pointer-o text-primary mr-1.5"></i>
                    <span class="text-gray-700">尝试次数: </span>
                    <span id="attempts" class="font-semibold ml-1.5">0</span>
                </div>
                
                <div class="bg-white rounded-lg shadow-md px-3 py-2 flex items-center text-sm">
                    <i class="fa fa-check-circle text-primary mr-1.5"></i>
                    <span class="text-gray-700">匹配: </span>
                    <span id="matches" class="font-semibold ml-1.5">0/0</span>
                </div>
            </div>
            
            <div class="flex flex-wrap justify-center gap-3">
                <button id="startBtn" class="bg-primary hover:bg-primary/90 text-white text-sm font-bold py-2 px-5 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none">
                    开始游戏
                </button>
                <button id="historyBtn" class="bg-gray-700 hover:bg-gray-800 text-white text-sm font-bold py-2 px-5 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none">
                    查看历史
                </button>
            </div>
        </header>
        
        <!-- 游戏区域 - 上方是元素分类，下方是化合价选项 -->
        <div class="flex flex-col gap-6 mb-6">
            <!-- 上方：元素分类区域 -->
            <div id="categoriesContainer" class="opacity-50 pointer-events-none transition-opacity duration-500">
                <h2 class="text-sm sm:text-base font-semibold text-primary mb-3 text-center">元素分类</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- 元素分类卡片将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <!-- 下方：化合价选项区域 -->
            <div id="valencesContainer" class="opacity-50 pointer-events-none transition-opacity duration-500">
                <h2 class="text-sm sm:text-base font-semibold text-secondary mb-3 text-center">化合价选项</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                    <!-- 化合价选项将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
        
        <!-- 游戏结束弹窗 -->
        <div id="gameOverModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl p-5 sm:p-6 max-w-md w-full mx-3 transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
                <div class="text-center mb-3">
                    <div id="gameOverIcon" class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-green-100 mb-3">
                        <i class="fa fa-trophy text-2xl text-yellow-500"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800 mb-1.5" id="gameOverTitle">恭喜你！</h2>
                    <p class="text-gray-600 text-sm" id="completionText">你已完成所有化合价的匹配</p>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div id="finalTimeContainer" class="flex justify-between mb-2 pb-2 border-b border-gray-100">
                        <span class="text-gray-600 text-sm">用时/剩余时间:</span>
                        <span id="finalTime" class="font-semibold text-gray-800 text-sm">00:00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 text-sm">尝试次数:</span>
                        <span id="finalAttempts" class="font-semibold text-gray-800 text-sm">0</span>
                    </div>
                    <div class="flex justify-between mt-2 pt-2 border-t border-gray-100">
                        <span class="text-gray-600 text-sm">元素数量:</span>
                        <span id="finalElementCount" class="font-semibold text-gray-800 text-sm">0</span>
                    </div>
                </div>
                
                <div class="flex flex-col gap-2">
                    <button id="closeResultBtn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 focus:outline-none">
                        返回主页
                    </button>
                    <button id="playAgainBtn" class="w-full bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none">
                        再玩一次
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 再玩一次确认弹窗 -->
        <div id="playAgainConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl p-5 max-w-md w-full mx-3 transform transition-all duration-300 scale-95 opacity-0" id="playAgainModalContent">
                <div class="text-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800 mb-2">准备开始新游戏</h2>
                    <p class="text-gray-600 text-sm">请确认你的游戏设置，然后点击开始</p>
                </div>
                
                <button id="confirmStartBtn" class="w-full bg-primary hover:bg-primary/90 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none">
                    开始游戏
                </button>
            </div>
        </div>
        
        <!-- 历史记录弹窗 -->
        <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl p-5 max-w-2xl w-full mx-3 max-h-[70vh] overflow-hidden flex flex-col" id="historyModalContent">
                <div class="text-center mb-3">
                    <h2 class="text-lg font-bold text-gray-800 mb-1.5">游戏历史记录</h2>
                    <p class="text-gray-600 text-sm">所有游戏结果记录（成功/失败）</p>
                </div>
                
                <div class="flex-1 overflow-y-auto mb-4 text-sm">
                    <div id="historyList" class="space-y-3">
                        <!-- 历史记录将通过JavaScript动态生成 -->
                        <div class="text-center text-gray-500 py-6 text-sm" id="emptyHistory">
                            暂无历史记录
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button id="clearHistoryBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm font-bold py-2 px-3 rounded-lg shadow-md transition-all duration-300 focus:outline-none">
                        清空记录
                    </button>
                    <button id="closeHistoryBtn" class="flex-1 bg-primary hover:bg-primary/90 text-white text-sm font-bold py-2 px-3 rounded-lg shadow-md transition-all duration-300 focus:outline-none">
                        关闭
                    </button>
                    <button id="exportHistoryBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-2 px-3 rounded-lg shadow-md transition-all duration-300 focus:outline-none">
                        <i class="fa fa-download mr-1"></i> 导出记录
                    </button>
                </div>
            </div>
        </div>
        
        <footer class="text-center text-gray-500 text-xs py-3">
            <p>化学化合价归类游戏 | 基于九年级化学学习资料</p>
        </footer>
    </div>

    <script>
        // 化合价数据 - 按难度分级，每个元素可能有多个化合价
        const valenceData = {
            easy: [
                { element: 'H（氢）', valences: ['+1']},
                { element: 'O（氧）', valences: ['-2']},
                { element: 'Na（钠）', valences: ['+1']},
                { element: 'K（钾）', valences: ['+1']},
                { element: 'Ca（钙）', valences: ['+2']},
                { element: 'Mg（镁）', valences: ['+2']},
                { element: 'Al（铝）', valences: ['+3']},
                { element: 'Cl（氯）', valences: ['-1']},
                { element: 'N（氮）', valences: ['-3']},
                { element: 'S（硫）', valences: ['-2']}
            ],
            medium: [
                { element: 'H（氢）', valences: ['+1']},
                { element: 'O（氧）', valences: ['-2', '-1']},
                { element: 'Na（钠）', valences: ['+1']},
                { element: 'Ca（钙）', valences: ['+2']},
                { element: 'Al（铝）', valences: ['+3']},
                { element: 'Fe（铁）', valences: ['+2', '+3']},
                { element: 'Cu（铜）', valences: ['+2']},
                { element: 'Zn（锌）', valences: ['+2']},
                { element: 'Cl⁻（氯离子）', valences: ['-1']},
                { element: 'OH⁻（氢氧根）', valences: ['-1']},
                { element: 'NO₃⁻（硝酸根）', valences: ['-1']},
                { element: 'SO₄²⁻（硫酸根）', valences: ['-2']},
                { element: 'CO₃²⁻（碳酸根）', valences: ['-2']},
                { element: 'NH₄⁺（铵根）', valences: ['+1']}
            ],
            hard: [
                { element: 'C（碳）', valences: ['+2', '+4']},
                { element: 'N（氮）', valences: ['-3', '+2', '+4', '+5']},
                { element: 'P（磷）', valences: ['-3', '+3', '+5']},
                { element: 'O（氧）', valences: ['-2', '-1']},
                { element: 'S（硫）', valences: ['-2', '+4', '+6']},
                { element: 'Cl（氯）', valences: ['-1', '+1', '+5', '+7']},
                { element: 'Fe（铁）', valences: ['+2', '+3']},
                { element: 'Cu（铜）', valences: ['+1', '+2']},
                { element: 'Mn（锰）', valences: ['+2', '+4', '+6', '+7']},
                { element: 'Cr（铬）', valences: ['+3', '+6']}
            ]
        };

        // 游戏状态
        const gameState = {
            isPlaying: false,
            draggedItem: null,
            matchedPairs: 0,
            totalPairs: 0, // 总共有多少个需要匹配的化合价
            attempts: 0,
            timer: null,
            seconds: 0,
            countdownSeconds: 0, // 倒计时剩余秒数
            originalCountdown: 0, // 初始倒计时秒数
            timingMode: 'timed', // 计时模式：timed/countdown/untimed
            difficulty: 'medium', // 难度级别
            currentElements: [], // 当前游戏使用的元素
            allValences: [], // 所有需要匹配的化合价（包括干扰项）
            correctMatches: {}, // 正确的匹配关系：{元素ID: [化合价1, 化合价2...]}
            gameStartTime: null, // 游戏开始时间戳
            isReset: false // 标记游戏是否已重置
        };

        // DOM 元素
        const categoriesContainer = document.getElementById('categoriesContainer').querySelector('div');
        const valencesContainer = document.getElementById('valencesContainer').querySelector('div');
        const startBtn = document.getElementById('startBtn');
        const historyBtn = document.getElementById('historyBtn');
        const timerDisplay = document.getElementById('timer');
        const timerLabel = document.getElementById('timerLabel');
        const timerContainer = document.getElementById('timerContainer');
        const attemptsDisplay = document.getElementById('attempts');
        const matchesDisplay = document.getElementById('matches');
        const gameOverModal = document.getElementById('gameOverModal');
        const modalContent = document.getElementById('modalContent');
        const finalTime = document.getElementById('finalTime');
        const finalTimeContainer = document.getElementById('finalTimeContainer');
        const finalAttempts = document.getElementById('finalAttempts');
        const finalElementCount = document.getElementById('finalElementCount');
        const playAgainBtn = document.getElementById('playAgainBtn');
        const closeResultBtn = document.getElementById('closeResultBtn');
        const elementCountSelect = document.getElementById('elementCount');
        const exportHistoryBtn = document.getElementById('exportHistoryBtn');
        const timingModeSelect = document.getElementById('timingMode');
        const countdownSettings = document.getElementById('countdownSettings');
        const countdownDuration = document.getElementById('countdownDuration');
        const completionText = document.getElementById('completionText');
        const gameOverTitle = document.getElementById('gameOverTitle');
        const gameOverIcon = document.getElementById('gameOverIcon');
        const historyModal = document.getElementById('historyModal');
        const historyModalContent = document.getElementById('historyModalContent');
        const closeHistoryBtn = document.getElementById('closeHistoryBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const difficultySelect = document.getElementById('difficulty');
        const playAgainConfirmModal = document.getElementById('playAgainConfirmModal');
        const playAgainModalContent = document.getElementById('playAgainModalContent');
        const confirmStartBtn = document.getElementById('confirmStartBtn');
        const emptyHistory = document.getElementById('emptyHistory');
        const historyList = document.getElementById('historyList');

        // 触摸事件状态变量
        const touchState = {
            isDragging: false,
            startTouchX: 0,    // 新增：触摸开始时的视口X坐标
            startTouchY: 0,    // 新增：触摸开始时的视口Y坐标
            initialLeft: 0,    // 新增：元素初始的文档左坐标
            initialTop: 0,     // 新增：元素初始的文档上坐标
            element: null,
            initialRect: null,
            initialZIndex: '',
            targetZones: null,
            lastMoveTime: 0,
            moveThrottle: 16
        };

        // 初始化事件监听
        function initEventListeners() {
            // 开始游戏按钮
            startBtn.addEventListener('click', startGame);
            
            // 查看历史按钮
            historyBtn.addEventListener('click', showHistory);
            
            // 关闭历史按钮
            closeHistoryBtn.addEventListener('click', hideHistory);
            
            // 清空历史按钮
            clearHistoryBtn.addEventListener('click', clearHistory);
            
            // 导出历史按钮
            exportHistoryBtn.addEventListener('click', exportHistory);
            
            // 再玩一次按钮
            playAgainBtn.addEventListener('click', () => {
                hideGameOverModal();
                showPlayAgainConfirm();
            });
            
            // 关闭结果按钮
            closeResultBtn.addEventListener('click', () => {
                hideGameOverModal();
                resetGame();
            });
            
            // 确认开始新游戏按钮
            confirmStartBtn.addEventListener('click', () => {
                hidePlayAgainConfirm();
                startGame();
            });
            
            // 计时方式选择变化
            timingModeSelect.addEventListener('change', toggleCountdownSettings);
            
            // 初始化时检查计时方式
            toggleCountdownSettings();
        }

        // 切换倒计时设置显示
        function toggleCountdownSettings() {
            if (timingModeSelect.value === 'countdown') {
                countdownSettings.classList.remove('hidden');
            } else {
                countdownSettings.classList.add('hidden');
            }
        }

        // 开始游戏
        function startGame() {
            // 重置游戏状态
            resetGameState();
            
            // 获取游戏设置
            const elementCount = parseInt(elementCountSelect.value);
            gameState.difficulty = difficultySelect.value;
            gameState.timingMode = timingModeSelect.value;
            
            // 设置倒计时（如果需要）
            if (gameState.timingMode === 'countdown') {
                gameState.countdownSeconds = parseInt(countdownDuration.value);
                gameState.originalCountdown = gameState.countdownSeconds;
                timerLabel.textContent = '剩余时间: ';
            } else if (gameState.timingMode === 'timed') {
                gameState.seconds = 0;
                timerLabel.textContent = '用时: ';
            } else {
                timerLabel.textContent = '时间: ';
                timerDisplay.textContent = '--:--';
            }
            
            // 选择随机元素
            gameState.currentElements = getRandomElements(elementCount, gameState.difficulty);
            
            // 生成元素分类
            createCategories();
            
            // 生成化合价选项
            createValenceOptions();
            
            // 更新UI状态
            document.getElementById('categoriesContainer').classList.remove('opacity-50', 'pointer-events-none');
            document.getElementById('valencesContainer').classList.remove('opacity-50', 'pointer-events-none');
            startBtn.disabled = true;
            startBtn.classList.add('opacity-70', 'cursor-not-allowed');
            startBtn.classList.remove('hover:bg-primary/90', 'hover:scale-105');
            
            // 开始计时
            if (gameState.timingMode !== 'untimed') {
                startTimer();
            }
            
            // 记录游戏开始时间
            gameState.gameStartTime = new Date().getTime();
            
            // 更新匹配计数显示
            updateMatchesDisplay();
        }

        // 重置游戏状态
        function resetGameState() {
            gameState.isPlaying = true;
            gameState.matchedPairs = 0;
            gameState.attempts = 0;
            gameState.correctMatches = {};
            gameState.allValences = [];
            gameState.isReset = false;
            
            // 清除计时器
            if (gameState.timer) {
                clearInterval(gameState.timer);
                gameState.timer = null;
            }
            
            // 重置显示
            attemptsDisplay.textContent = '0';
            timerDisplay.classList.remove('timer-warning');
        }

        // 重置游戏（回到初始状态）
        function resetGame() {
            resetGameState();
            
            // 清空容器
            categoriesContainer.innerHTML = '';
            valencesContainer.innerHTML = '';
            
            // 重置UI状态
            document.getElementById('categoriesContainer').classList.add('opacity-50', 'pointer-events-none');
            document.getElementById('valencesContainer').classList.add('opacity-50', 'pointer-events-none');
            startBtn.disabled = false;
            startBtn.classList.remove('opacity-70', 'cursor-not-allowed');
            startBtn.classList.add('hover:bg-primary/90', 'hover:scale-105');
        }

        // 从数据中选择随机元素
        function getRandomElements(count, difficulty) {
            const elements = valenceData[difficulty];
            const shuffled = [...elements].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        // 创建元素分类
        function createCategories() {
            categoriesContainer.innerHTML = '';
            
            gameState.currentElements.forEach((item, index) => {
                const categoryId = `category-${index}`;
                
                // 记录正确的匹配关系
                gameState.correctMatches[categoryId] = item.valences;
                gameState.totalPairs += item.valences.length;
                
                // 创建分类元素
                const category = document.createElement('div');
                category.id = categoryId;
                category.className = 'category-box bg-white rounded-lg shadow-md border-2 border-primary/20 p-3 flex flex-col';
                
                // 分类标题
                const title = document.createElement('h3');
                title.className = 'font-semibold text-primary mb-2 text-center';
                title.textContent = item.element;
                category.appendChild(title);
                
                // 化合价容器（用于放置拖放的化合价）
                const valenceDropZone = document.createElement('div');
                valenceDropZone.className = 'flex-1 flex flex-wrap gap-2 justify-center items-center p-1';
                valenceDropZone.setAttribute('data-element', item.element);
                
                // 添加拖放事件
                valenceDropZone.addEventListener('dragover', handleDragOver);
                valenceDropZone.addEventListener('dragleave', handleDragLeave);
                valenceDropZone.addEventListener('drop', handleDrop);
                
                category.appendChild(valenceDropZone);
                categoriesContainer.appendChild(category);
            });
        }

        // 创建化合价选项
        function createValenceOptions() {
            valencesContainer.innerHTML = '';
            
            // 收集所有正确的化合价
            const correctValences = [];
            Object.values(gameState.correctMatches).forEach(valences => {
                correctValences.push(...valences);
            });
            
            // 根据难度添加干扰项（错误的化合价）
            let distractors = [];
            const difficulty = gameState.difficulty;
            
            // 简单难度少一些干扰项，困难难度多一些
            const distractorCount = difficulty === 'easy' ? 3 : 
                                   difficulty === 'medium' ? 5 : 7;
            
            // 从所有化合价数据中收集可能的干扰项
            valenceData[difficulty].forEach(item => {
                distractors.push(...item.valences);
            });
            
            // 去重并排除正确的化合价
            distractors = [...new Set(distractors)].filter(v => !correctValences.includes(v));
            
            // 随机选择干扰项
            distractors = [...distractors].sort(() => 0.5 - Math.random()).slice(0, distractorCount);
            
            // 合并正确化合价和干扰项，并打乱顺序
            const allValences = [...correctValences, ...distractors]
                .sort(() => 0.5 - Math.random())
                .map((value, index) => {
                    // 找到这个化合价属于哪个元素
                    let elementId = null;
                    Object.entries(gameState.correctMatches).forEach(([id, valences]) => {
                        if (valences.includes(value)) {
                            elementId = id;
                        }
                    });
                    return { value, elementId, index };
                });
            
            // 保存所有化合价
            gameState.allValences = allValences;
            
            // 创建DOM元素
            allValences.forEach((valence, index) => {
                const valenceItem = document.createElement('div');
                valenceItem.className = 'valence-item bg-secondary/10 border-2 border-secondary/30 text-center font-bold rounded-lg shadow-md p-2 cursor-grab hover:shadow-lg transition-all duration-200 opacity-0 translate-y-4 touch-manipulation';
                valenceItem.draggable = true;
                valenceItem.dataset.valence = valence.value;
                valenceItem.dataset.index = index;
                if (valence.elementId) {
                    valenceItem.dataset.correctElement = valence.elementId;
                }
                
                // 添加内容
                const content = document.createElement('div');
                content.className = 'text-secondary';
                content.textContent = valence.value;
                valenceItem.appendChild(content);
                
                // 添加拖放事件
                valenceItem.addEventListener('dragstart', handleDragStart);
                valenceItem.addEventListener('dragend', handleDragEnd);
                
                // 添加触摸事件支持
                valenceItem.addEventListener('touchstart', handleTouchStart, { passive: true });
                valenceItem.addEventListener('touchmove', handleTouchMove, { passive: false });
                valenceItem.addEventListener('touchend', handleTouchEnd);
                
                valencesContainer.appendChild(valenceItem);
                
                // 添加延迟动画效果
                setTimeout(() => {
                    valenceItem.classList.remove('opacity-0', 'translate-y-4');
                }, 50 * index);
            });
        }

        // 拖拽开始
        function handleDragStart(e) {
            if (!gameState.isPlaying) return;
            
            gameState.draggedItem = this;
            this.classList.add('dragging');
            
            // 延迟设置不透明度，避免拖拽图像闪烁
            setTimeout(() => {
                this.style.opacity = '0.4';
            }, 0);
            
            // 设置拖拽数据
            e.dataTransfer.setData('text/plain', this.dataset.index);
        }

        // 拖拽结束
        function handleDragEnd() {
            if (!gameState.isPlaying) return;
            
            this.classList.remove('dragging');
            this.style.opacity = '';
            
            // 移除所有拖放区域的高亮
            document.querySelectorAll('.category-box').forEach(box => {
                box.classList.remove('drag-over');
            });
        }

        // 拖拽经过
        function handleDragOver(e) {
            if (!gameState.isPlaying || !gameState.draggedItem) return;
            
            e.preventDefault();
            this.closest('.category-box').classList.add('drag-over');
        }

        // 拖拽离开
        function handleDragLeave() {
            if (!gameState.isPlaying) return;
            
            this.closest('.category-box').classList.remove('drag-over');
        }

        // 放置
        function handleDrop(e) {
            if (!gameState.isPlaying || !gameState.draggedItem) return;
            
            e.preventDefault();
            const categoryBox = this.closest('.category-box');
            categoryBox.classList.remove('drag-over');
            
            const index = e.dataTransfer.getData('text/plain');
            const valenceItem = document.querySelector(`.valence-item[data-index="${index}"]`);
            
            // 如果已经被放置过，不再处理
            if (!valenceItem || valenceItem.parentNode !== valencesContainer) return;
            
            // 增加尝试次数
            gameState.attempts++;
            attemptsDisplay.textContent = gameState.attempts;
            
            // 获取当前分类和化合价
            const categoryId = categoryBox.id;
            const valenceValue = valenceItem.dataset.valence;
            
            // 检查是否匹配正确
            const isCorrect = gameState.correctMatches[categoryId]?.includes(valenceValue) || false;
            
            // 克隆元素并添加到分类中
            const clonedItem = valenceItem.cloneNode(true);
            clonedItem.draggable = false;
            clonedItem.classList.remove('cursor-grab', 'hover:shadow-lg');
            clonedItem.classList.add('cursor-default');
            
            // 移除触摸事件监听
            clonedItem.removeEventListener('touchstart', handleTouchStart);
            clonedItem.removeEventListener('touchmove', handleTouchMove);
            clonedItem.removeEventListener('touchend', handleTouchEnd);
            
            // 根据是否正确设置样式
            if (isCorrect) {
                clonedItem.classList.remove('bg-secondary/10', 'border-secondary/30', 'text-secondary');
                clonedItem.classList.add('bg-green-100', 'border-green-300', 'text-green-700', 'matched');
                
                // 增加匹配计数
                gameState.matchedPairs++;
                updateMatchesDisplay();
                
                // 隐藏原始元素
                valenceItem.style.display = 'none';
                
                // 检查游戏是否结束
                if (gameState.matchedPairs >= gameState.totalPairs) {
                    endGame(true);
                }
            } else {
                clonedItem.classList.remove('bg-secondary/10', 'border-secondary/30', 'text-secondary');
                clonedItem.classList.add('bg-red-100', 'border-red-300', 'text-red-700');
                
                // 3秒后移除错误的放置
                setTimeout(() => {
                    if (clonedItem.parentNode) {
                        clonedItem.parentNode.removeChild(clonedItem);
                    }
                }, 1500);
            }
            
            // 添加到分类中
            this.appendChild(clonedItem);
        }

        // 触摸开始事件
        function handleTouchStart(e) {
            if (!gameState.isPlaying) return;
            e.preventDefault();
            
            const touch = e.touches[0];
            touchState.element = this;
            touchState.initialRect = this.getBoundingClientRect();
            
            // 保存初始z-index以便恢复
            touchState.initialZIndex = this.style.zIndex || '';
            
            // 关键修改：记录触摸点在视口中的原始位置
            touchState.startTouchX = touch.clientX;
            touchState.startTouchY = touch.clientY;
            
            // 关键修改：计算元素初始在文档中的位置（考虑滚动）
            const scrollX = window.scrollX;
            const scrollY = window.scrollY;
            touchState.initialLeft = touchState.initialRect.left + scrollX;
            touchState.initialTop = touchState.initialRect.top + scrollY;
            
            // 缓存目标区域
            touchState.targetZones = document.querySelectorAll('.category-box [data-element]');
            
            // 设置拖拽状态和样式
            touchState.isDragging = true;
            this.classList.add('dragging');
            this.style.position = 'fixed';
            this.style.width = `${touchState.initialRect.width}px`;
            this.style.transform = 'translate(0, 0)';
            this.style.willChange = 'transform';
            this.style.zIndex = '1000';
            this.style.transition = 'none';
            this.style.pointerEvents = 'none';
        }

        // 触摸移动事件处理（修复位置更新）
        function handleTouchMove(e) {
            const now = Date.now();
            if (now - touchState.lastMoveTime < touchState.moveThrottle) return;
            touchState.lastMoveTime = now;
            
            if (!touchState.isDragging || !gameState.isPlaying) return;
            e.preventDefault();
            
            const touch = e.touches[0];
            const scrollX = window.scrollX;
            const scrollY = window.scrollY;
            
            // 关键修改：计算元素新位置 = 初始位置 + 触摸移动距离
            const moveX = touch.clientX - touchState.startTouchX;
            const moveY = touch.clientY - touchState.startTouchY;
            const currentX = touchState.initialLeft + moveX - scrollX;  // 减去滚动偏移，因为使用fixed定位
            const currentY = touchState.initialTop + moveY - scrollY;
            
            // 更新元素位置（确保与手指位置一致）
            touchState.element.style.transform = `translate(${currentX}px, ${currentY}px)`;  
            
            // 碰撞检测逻辑保持不变
            touchState.targetZones.forEach(zone => {
                const box = zone.closest('.category-box');
                const boxRect = box.getBoundingClientRect();
                const touchX = touch.clientX;
                const touchY = touch.clientY;
                
                const isOver = touchX >= boxRect.left && touchX <= boxRect.right &&
                            touchY >= boxRect.top && touchY <= boxRect.bottom;
                
                box.classList.toggle('drag-over', isOver);
            });
        }

        // 触摸结束事件处理（保持不变）
        function handleTouchEnd(e) {
            if (!touchState.isDragging || !gameState.isPlaying || !touchState.element) return;
            
            const element = touchState.element;
            const touch = e.changedTouches[0];
            
            let targetZone = null;
            touchState.targetZones.forEach(zone => {
                const box = zone.closest('.category-box');
                if (box.classList.contains('drag-over')) {
                    targetZone = zone;
                }
                box.classList.remove('drag-over');
            });
            
            if (targetZone) {
                handleDrop({
                    preventDefault: () => {},
                    target: targetZone,
                    dataTransfer: {
                        getData: () => element.dataset.index
                    }
                });
            }
            
            // 重置样式和状态
            element.style.position = '';
            element.style.width = '';
            element.style.transform = '';
            element.style.willChange = '';
            element.style.zIndex = touchState.initialZIndex;
            element.style.pointerEvents = '';
            element.style.transition = '';
            element.classList.remove('dragging');
            
            // 重置触摸状态
            touchState.isDragging = false;
            touchState.element = null;
            touchState.targetZones = null;
        }

        // 开始计时器
        function startTimer() {
            if (gameState.timer) {
                clearInterval(gameState.timer);
            }
            
            gameState.timer = setInterval(() => {
                if (!gameState.isPlaying) {
                    clearInterval(gameState.timer);
                    return;
                }
                
                if (gameState.timingMode === 'countdown') {
                    // 倒计时模式
                    gameState.countdownSeconds--;
                    
                    // 时间不足10秒时添加警告效果
                    if (gameState.countdownSeconds <= 10) {
                        timerDisplay.classList.add('timer-warning');
                    }
                    
                    // 倒计时结束
                    if (gameState.countdownSeconds <= 0) {
                        clearInterval(gameState.timer);
                        endGame(false);
                        return;
                    }
                    
                    timerDisplay.textContent = formatTime(gameState.countdownSeconds);
                } else {
                    // 计时模式
                    gameState.seconds++;
                    timerDisplay.textContent = formatTime(gameState.seconds);
                }
            }, 1000);
        }

        // 格式化时间（秒 -> mm:ss）
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // 更新匹配计数显示
        function updateMatchesDisplay() {
            matchesDisplay.textContent = `${gameState.matchedPairs}/${gameState.totalPairs}`;
        }

        // 结束游戏
        function endGame(isSuccess) {
            gameState.isPlaying = false;
            
            // 停止计时器
            if (gameState.timer) {
                clearInterval(gameState.timer);
                gameState.timer = null;
            }
            
            // 计算游戏用时（毫秒）
            const gameEndTime = new Date().getTime();
            const gameDurationMs = gameEndTime - gameState.gameStartTime;
            
            // 准备结果数据
            const resultData = {
                date: new Date().toISOString(),
                durationMs: gameDurationMs,
                attempts: gameState.attempts,
                elementCount: gameState.currentElements.length,
                difficulty: gameState.difficulty,
                isSuccess: isSuccess,
                timingMode: gameState.timingMode,
                finalTimeSeconds: gameState.timingMode === 'countdown' ? gameState.countdownSeconds : gameState.seconds
            };
            
            // 保存结果到本地存储
            saveGameResult(resultData);
            
            // 更新弹窗内容
            if (isSuccess) {
                gameOverTitle.textContent = '恭喜你！';
                completionText.textContent = '你已完成所有化合价的匹配';
                gameOverIcon.innerHTML = '<i class="fa fa-trophy text-2xl text-yellow-500"></i>';
                gameOverIcon.className = 'inline-flex items-center justify-center w-12 h-12 rounded-full bg-green-100 mb-3';
            } else {
                gameOverTitle.textContent = '时间到！';
                completionText.textContent = `你完成了 ${gameState.matchedPairs}/${gameState.totalPairs} 个匹配`;
                gameOverIcon.innerHTML = '<i class="fa fa-clock-o text-2xl text-red-500"></i>';
                gameOverIcon.className = 'inline-flex items-center justify-center w-12 h-12 rounded-full bg-red-100 mb-3';
            }
            
            // 更新最终时间显示
            if (gameState.timingMode === 'countdown') {
                finalTimeContainer.querySelector('span:first-child').textContent = '剩余时间:';
                finalTime.textContent = formatTime(resultData.finalTimeSeconds);
            } else if (gameState.timingMode === 'timed') {
                finalTimeContainer.querySelector('span:first-child').textContent = '用时:';
                finalTime.textContent = formatTime(resultData.finalTimeSeconds);
            } else {
                finalTimeContainer.querySelector('span:first-child').textContent = '用时:';
                finalTime.textContent = formatTime(Math.floor(gameDurationMs / 1000));
            }
            
            // 更新其他结果信息
            finalAttempts.textContent = resultData.attempts;
            finalElementCount.textContent = resultData.elementCount;
            
            // 显示游戏结束弹窗
            showGameOverModal();
        }

        // 显示游戏结束弹窗
        function showGameOverModal() {
            gameOverModal.classList.remove('hidden');
            // 触发动画
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        // 隐藏游戏结束弹窗
        function hideGameOverModal() {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            // 完全隐藏弹窗
            setTimeout(() => {
                gameOverModal.classList.add('hidden');
            }, 300);
        }

        // 显示再玩一次确认弹窗
        function showPlayAgainConfirm() {
            playAgainConfirmModal.classList.remove('hidden');
            // 触发动画
            setTimeout(() => {
                playAgainModalContent.classList.remove('scale-95', 'opacity-0');
                playAgainModalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        // 隐藏再玩一次确认弹窗
        function hidePlayAgainConfirm() {
            playAgainModalContent.classList.remove('scale-100', 'opacity-100');
            playAgainModalContent.classList.add('scale-95', 'opacity-0');
            // 完全隐藏弹窗
            setTimeout(() => {
                playAgainConfirmModal.classList.add('hidden');
            }, 300);
        }

        // 显示历史记录
        function showHistory() {
            loadHistory();
            historyModal.classList.remove('hidden');
            // 触发动画
            setTimeout(() => {
                historyModalContent.classList.remove('scale-95', 'opacity-0');
                historyModalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        // 隐藏历史记录
        function hideHistory() {
            historyModalContent.classList.remove('scale-100', 'opacity-100');
            historyModalContent.classList.add('scale-95', 'opacity-0');
            // 完全隐藏弹窗
            setTimeout(() => {
                historyModal.classList.add('hidden');
            }, 300);
        }

        // 保存游戏结果
        function saveGameResult(result) {
            let history = JSON.parse(localStorage.getItem('valenceGameHistory') || '[]');
            history.unshift(result); // 添加到开头
            
            // 限制历史记录数量（最多50条）
            if (history.length > 50) {
                history = history.slice(0, 50);
            }
            
            localStorage.setItem('valenceGameHistory', JSON.stringify(history));
        }

        // 加载历史记录
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('valenceGameHistory') || '[]');
            historyList.innerHTML = '';
            
            if (history.length === 0) {
                historyList.appendChild(emptyHistory);
                return;
            }
            
            // 隐藏空历史提示
            emptyHistory.remove();
            
            // 添加历史记录项
            history.forEach((item, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = `bg-gray-50 rounded-lg p-3 border-l-4 ${item.isSuccess ? 'border-green-500' : 'border-red-500'}`;
                
                // 格式化日期
                const date = new Date(item.date);
                const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                
                // 格式化时间
                let timeText = '';
                if (item.timingMode === 'countdown') {
                    timeText = `剩余时间: ${formatTime(item.finalTimeSeconds)}`;
                } else {
                    timeText = `用时: ${formatTime(item.finalTimeSeconds)}`;
                }
                
                // 设置难度文本
                const difficultyText = item.difficulty === 'easy' ? '简单' : 
                                      item.difficulty === 'medium' ? '中等' : '困难';
                
                // 设置内容
                historyItem.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-medium ${item.isSuccess ? 'text-green-700' : 'text-red-700'}">
                            ${item.isSuccess ? '成功完成' : '未完成'}
                        </span>
                        <span class="text-xs text-gray-500">${formattedDate}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs text-gray-600">
                        <div>元素数量: ${item.elementCount}种</div>
                        <div>难度: ${difficultyText}</div>
                        <div>${timeText}</div>
                        <div>尝试次数: ${item.attempts}</div>
                    </div>
                `;
                
                historyList.appendChild(historyItem);
            });
        }

        // 清空历史记录
        function clearHistory() {
            if (confirm('确定要清空所有历史记录吗？此操作不可恢复。')) {
                localStorage.removeItem('valenceGameHistory');
                loadHistory();
            }
        }

        // 导出历史记录
        function exportHistory() {
            const history = JSON.parse(localStorage.getItem('valenceGameHistory') || '[]');
            if (history.length === 0) {
                alert('没有历史记录可导出');
                return;
            }
            
            // 转换为CSV格式
            let csvContent = "日期,状态,元素数量,难度,时间,尝试次数\n";
            
            history.forEach(item => {
                const date = new Date(item.date);
                const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                
                let timeText = '';
                if (item.timingMode === 'countdown') {
                    timeText = `剩余${formatTime(item.finalTimeSeconds)}`;
                } else {
                    timeText = formatTime(item.finalTimeSeconds);
                }
                
                const difficultyText = item.difficulty === 'easy' ? '简单' : 
                                      item.difficulty === 'medium' ? '中等' : '困难';
                
                csvContent += `"${formattedDate}",`;
                csvContent += `"${item.isSuccess ? '成功' : '失败'}",`;
                csvContent += `${item.elementCount},`;
                csvContent += `"${difficultyText}",`;
                csvContent += `"${timeText}",`;
                csvContent += `${item.attempts}\n`;
            });
            
            // 创建下载链接
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `化合价游戏历史记录_${new Date().toLocaleDateString()}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 初始化游戏
        function init() {
            initEventListeners();
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
